<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>我的动画 Tier List</title>
    <link rel="stylesheet" href="my-tier-list.css" />
    <link rel="stylesheet" href="style-options.css" />
    <link rel="stylesheet" href="gradient-backgrounds.css" />
    <link rel="stylesheet" href="comments-styles.css" />
    <link rel="stylesheet" href="fix-overlap.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="libs/sortable/Sortable.min.js"></script>
    <script src="libs/html2canvas/html2canvas.min.js"></script>
    <script src="libs/masonry/masonry.pkgd.min.js"></script>
    <script src="libs/imagesloaded/imagesloaded.pkgd.min.js"></script>

    <!-- Markdown 渲染库 - 多CDN备份 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      // CDN备份机制
      if (typeof marked === 'undefined') {
        console.warn('主CDN加载失败，尝试备用CDN...');
        document.write('<script src="https://unpkg.com/marked/marked.min.js"><\/script>');
      }
    </script>
    <script>
      // 最终检查
      setTimeout(() => {
        if (typeof marked === 'undefined') {
          console.error('所有CDN都加载失败！Markdown功能将不可用');
        } else {
          console.log('marked库加载成功，版本:', marked.getDefaults ? 'v4+' : '未知');
        }
      }, 100);
    </script>

    <!-- 代码高亮库 -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" />

    <!-- Google Generative AI SDK -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
  </head>
  <body>
    <!-- 毛玻璃效果层 -->
    <div id="glassmorphism-layer" class="glassmorphism-layer"></div>

    <!-- 自定义标题区域 -->
    <div class="custom-title-container">
      <h1 id="custom-title" class="custom-title">我的动画 Tier List</h1>
      <button id="edit-title-btn" class="edit-title-btn">
        <i class="fas fa-edit"></i>
      </button>
    </div>

    <!-- 统一设置菜单按钮 -->
    <div class="settings-menu-container">
      <button id="settings-menu-btn" class="settings-menu-btn">
        <i class="fas fa-cog"></i>
      </button>

      <!-- 背景设置按钮 -->
      <div class="background-settings-container">
        <button id="background-settings-btn" class="background-settings-btn" title="背景与主题设置">
          <i class="fas fa-palette"></i>
        </button>
      </div>

      <!-- 设置菜单面板 -->
      <div id="settings-menu-panel" class="settings-menu-panel">
        <div class="settings-section">
          <h3 class="settings-section-title">显示选项</h3>
          <div class="settings-option">
            <span class="settings-option-label">显示动画标题</span>
            <label class="toggle-switch">
              <input type="checkbox" id="title-display-toggle" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <div class="settings-section">
          <h3 class="settings-section-title">截图功能</h3>
          <div class="screenshot-options">
            <button id="toggle-screenshot-mode-btn" class="export-btn">
              <i class="fas fa-camera"></i>
              <span>启用截图模式</span>
            </button>

            <!-- 截图帮助折叠区域 -->
            <div class="screenshot-help-section">
              <button class="screenshot-help-toggle" id="screenshot-help-toggle">
                <i class="fas fa-question-circle"></i>
                <span>如何使用？</span>
                <i class="fas fa-chevron-down toggle-icon"></i>
              </button>

              <div class="screenshot-help-content" id="screenshot-help-content">
                <div class="help-method">
                  <h4><i class="fas fa-desktop"></i> 方法一：Chrome开发者工具（推荐）</h4>
                  <ol>
                    <li>启用截图模式后，按 <kbd>F12</kbd> 打开开发者工具</li>
                    <li>按 <kbd>Ctrl+Shift+P</kbd> (Windows) 或 <kbd>Cmd+Shift+P</kbd> (Mac) 打开命令面板</li>
                    <li>
                      输入 "screenshot" 或"截图"，选择以下选项之一：
                      <ul>
                        <li><strong>英文界面：</strong> "Capture full size screenshot"</li>
                        <li><strong>中文界面：</strong> "捕获完整尺寸屏幕截图"</li>
                      </ul>
                    </li>
                    <li>等待截图完成并自动下载</li>
                    <li>完成后点击"退出截图模式"恢复正常</li>
                  </ol>
                </div>

                <div class="help-method">
                  <h4><i class="fas fa-mouse-pointer"></i> 方法二：节点截图</h4>
                  <ol>
                    <li>启用截图模式后，按 <kbd>F12</kbd> 打开开发者工具</li>
                    <li>在Elements/元素面板中，右键点击想要截图的元素</li>
                    <li>
                      选择截图选项：
                      <ul>
                        <li><strong>英文界面：</strong> "Capture node screenshot"</li>
                        <li><strong>中文界面：</strong> "捕获节点屏幕截图"</li>
                      </ul>
                    </li>
                    <li>截图将自动下载</li>
                  </ol>
                </div>

                <div class="help-method">
                  <h4><i class="fas fa-keyboard"></i> 快捷键</h4>
                  <p>按 <kbd>Ctrl+Alt+C</kbd> 快速切换截图模式</p>
                </div>

                <div class="help-note">
                  <p>
                    <i class="fas fa-lightbulb"></i>
                    <strong>提示：</strong>截图模式会临时修复背景显示问题，确保完整页面截图包含正确的背景效果。
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3 class="settings-section-title">导出与分享</h3>
          <div class="export-options">
            <button id="export-image-btn" class="export-btn">
              <i class="fas fa-image"></i>
              <span>Tier部分导出为图片</span>
            </button>
            <button id="export-json-btn" class="export-btn">
              <i class="fas fa-file-export"></i>
              <span>导出数据</span>
            </button>
            <button id="import-json-btn" class="export-btn">
              <i class="fas fa-file-import"></i>
              <span>导入数据</span>
            </button>
            <button id="share-link-btn" class="export-btn">
              <i class="fas fa-share-alt"></i>
              <span>生成分享链接(不可用)</span>
            </button>
            <input type="file" id="import-file-input" accept=".json" style="display: none" />
          </div>
        </div>

        <div class="settings-section">
          <h3 class="settings-section-title">AI 分析</h3>
          <div class="export-options">
            <button id="generate-taste-report-btn" class="export-btn" title="让AI分析您的动画偏好">
              <i class="fas fa-brain"></i>
              <span>生成总结报告</span>
            </button>
          </div>
        </div>

        <div class="settings-section">
          <h3 class="settings-section-title">Tier管理 <span class="settings-subtitle">(分数细化)</span></h3>
          <div class="tier-dropdown-list">
            <!-- 这里的内容将由JavaScript动态生成 -->
          </div>
        </div>
      </div>

      <!-- 背景设置面板 -->
      <div id="background-settings-panel" class="background-settings-panel">
        <div class="background-panel-header">
          <h3><i class="fas fa-palette"></i> 背景与主题设置</h3>
        </div>
        <div class="background-panel-content">
          <!-- 渐变主题选择 -->
          <div class="background-section">
            <h4 class="background-section-title"><i class="fas fa-fill-drip"></i> 渐变主题</h4>
            <div class="gradient-selection-full">
              <div class="gradient-mini-grid">
                <div
                  class="gradient-mini-preview gradient-deep-blue active"
                  data-gradient="deep-blue"
                  title="深蓝夜空"
                ></div>
                <div class="gradient-mini-preview gradient-aurora" data-gradient="aurora" title="极光紫"></div>
                <div class="gradient-mini-preview gradient-sakura" data-gradient="sakura" title="樱花粉"></div>
                <div class="gradient-mini-preview gradient-neon" data-gradient="neon" title="霓虹夜景"></div>
                <div class="gradient-mini-preview gradient-ocean" data-gradient="ocean" title="海洋深蓝"></div>
                <div class="gradient-mini-preview gradient-golden" data-gradient="golden" title="黄金时光"></div>
                <div class="gradient-mini-preview gradient-emerald" data-gradient="emerald" title="翡翠绿野"></div>
                <div class="gradient-mini-preview gradient-cosmic" data-gradient="cosmic" title="宇宙星辰"></div>
                <div class="gradient-mini-preview gradient-lavender" data-gradient="lavender" title="薰衣草"></div>
                <div class="gradient-mini-preview gradient-mystic" data-gradient="mystic" title="深紫神秘"></div>
                <div class="gradient-mini-preview gradient-steel" data-gradient="steel" title="钢铁机械"></div>
                <div class="gradient-mini-preview gradient-mint" data-gradient="mint" title="薄荷清新"></div>
                <div class="gradient-mini-preview gradient-volcano" data-gradient="volcano" title="火山岩浆"></div>
                <div class="gradient-mini-preview gradient-crystal" data-gradient="crystal" title="水晶冰雪"></div>
                <div class="gradient-mini-preview gradient-spectrum" data-gradient="spectrum" title="光谱彩虹"></div>
                <div class="gradient-mini-preview gradient-shadow" data-gradient="shadow" title="暗影深渊"></div>
                <div class="gradient-mini-preview gradient-rose-gold" data-gradient="rose-gold" title="玫瑰金"></div>
                <div class="gradient-mini-preview gradient-nordic" data-gradient="nordic" title="极光北欧"></div>
                <div class="gradient-mini-preview gradient-cyberpunk" data-gradient="cyberpunk" title="赛博朋克"></div>
                <div class="gradient-mini-preview gradient-sunset" data-gradient="sunset" title="夕阳西下"></div>
              </div>

              <!-- 快速主题预设 -->
              <div class="quick-theme-buttons">
                <button
                  class="quick-theme-btn"
                  onclick="gradientController.applyPreset('anime-night')"
                  title="极光紫 + 粒子 + 光晕"
                >
                  <i class="fas fa-star"></i>
                  动漫之夜
                </button>
                <button
                  class="quick-theme-btn"
                  onclick="gradientController.applyPreset('cyberpunk-city')"
                  title="霓虹夜景 + 粒子"
                >
                  <i class="fas fa-robot"></i>
                  赛博朋克
                </button>
                <button
                  class="quick-theme-btn"
                  onclick="gradientController.applyPreset('peaceful-nature')"
                  title="翡翠绿野 + 光晕"
                >
                  <i class="fas fa-leaf"></i>
                  自然宁静
                </button>
                <button
                  class="quick-theme-btn"
                  onclick="gradientController.applyPreset('minimal-focus')"
                  title="暗影深渊"
                >
                  <i class="fas fa-circle"></i>
                  极简专注
                </button>
                <button
                  class="quick-theme-btn random"
                  onclick="gradientController.randomTheme()"
                  title="随机主题和效果"
                >
                  <i class="fas fa-dice"></i>
                  随机主题
                </button>
              </div>
            </div>
          </div>

          <!-- 视觉特效 -->
          <div class="background-section">
            <h4 class="background-section-title"><i class="fas fa-magic"></i> 视觉特效</h4>
            <div class="settings-option">
              <span class="settings-option-label">粒子效果</span>
              <label class="toggle-switch">
                <input type="checkbox" id="particles-effect-toggle" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-option">
              <span class="settings-option-label">光晕效果</span>
              <label class="toggle-switch">
                <input type="checkbox" id="glow-effect-toggle" />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>

          <!-- 自定义背景 -->
          <div class="background-section">
            <h4 class="background-section-title"><i class="fas fa-image"></i> 自定义背景</h4>
            <div class="settings-option">
              <span class="settings-option-label">使用自定义背景</span>
              <label class="toggle-switch">
                <input type="checkbox" id="custom-bg-toggle" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="bg-upload-container" style="display: none">
              <div class="bg-preview">
                <div class="preview-placeholder">
                  <i class="fas fa-image"></i>
                  <p>背景预览</p>
                </div>
              </div>
              <div class="bg-controls">
                <label for="bg-file-input" class="bg-upload-btn">
                  <i class="fas fa-upload"></i>
                  <span>上传背景图片</span>
                </label>
                <input type="file" id="bg-file-input" accept="image/*" style="display: none" />
              </div>
              <div class="bg-effects">
                <div class="settings-option">
                  <span class="settings-option-label">毛玻璃效果</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="glassmorphism-toggle" checked />
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div class="blur-strength">
                  <div class="blur-strength-header">
                    <span class="settings-option-label">模糊强度</span>
                    <span class="blur-value">10px</span>
                  </div>
                  <input type="range" id="blur-strength" min="0" max="20" value="10" class="blur-slider" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tier-list-container">
      <!-- Tier 10 -->
      <div class="tier-row" id="tier-10">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="100, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">10</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>

      <!-- Tier 9.5 -->
      <div class="tier-row half-tier" id="tier-9.5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="93, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">9.5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
      <!-- Tier 9 -->
      <div class="tier-row" id="tier-9">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="87, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">9</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>

      <!-- Tier 8.5 -->
      <div class="tier-row half-tier" id="tier-8.5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="83, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">8.5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
      <!-- Tier 8 -->
      <div class="tier-row" id="tier-8">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="79, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">8</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>

      <!-- Tier 7.5 -->
      <div class="tier-row half-tier" id="tier-7.5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="75, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">7.5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
      <!-- Tier 7 -->
      <div class="tier-row" id="tier-7">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="70, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">7</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>

      <!-- Tier 6.5 -->
      <div class="tier-row half-tier" id="tier-6.5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="65, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">6.5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
      <!-- Tier 6 -->
      <div class="tier-row" id="tier-6">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="60, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">6</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>

      <!-- Tier 5.5 -->
      <div class="tier-row half-tier" id="tier-5.5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="55, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">5.5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
      <!-- Tier 5 -->
      <div class="tier-row" id="tier-5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="50, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>

      <!-- Tier 4.5 -->
      <div class="tier-row half-tier" id="tier-4.5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="45, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">4.5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
      <!-- Tier 4 -->
      <div class="tier-row" id="tier-4">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="40, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">4</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>

      <!-- Tier 3.5 -->
      <div class="tier-row half-tier" id="tier-3.5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="35, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">3.5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
      <!-- Tier 3 -->
      <div class="tier-row" id="tier-3">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="30, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">3</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>

      <!-- Tier 2.5 -->
      <div class="tier-row half-tier" id="tier-2.5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="25, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">2.5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
      <!-- Tier 2 -->
      <div class="tier-row" id="tier-2">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="20, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">2</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>

      <!-- Tier 1.5 -->
      <div class="tier-row half-tier" id="tier-1.5">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="15, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">1.5</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
      <!-- Tier 1 -->
      <div class="tier-row" id="tier-1">
        <div class="tier-label-container">
          <div class="tier-label">
            <svg viewBox="0 0 36 36" class="circular-chart white">
              <path
                class="circle-bg"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <path
                class="circle"
                stroke-dasharray="10, 100"
                d="M18 2.5
                              a 15.5 15.5 0 0 1 0 31
                              a 15.5 15.5 0 0 1 0 -31"
              />
              <text x="18" y="19" class="percentage">1</text>
            </svg>
          </div>
        </div>
        <div class="tier-cards">
          <div class="card"></div>
        </div>
      </div>
    </div>

    <script src="my-tier-list.js"></script>
    <script src="comments.js"></script>
    <script src="gradient-controller.js"></script>
    <script>
      // 初始化渐变控制器
      const gradientController = new GradientController();

      // 关闭背景设置面板
      function closeBackgroundPanel() {
        const panel = document.getElementById('background-settings-panel');
        if (panel) {
          panel.classList.remove('active');
        }
      }

      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', function () {
        // 初始化所有功能
        initializeApp();
      });

      function initializeApp() {
        // TODO: 在这里添加应用初始化逻辑
        // 例如: initSettingsMenu(), initBackgroundSettings(), renderTierCards() 等
        // 目前你可以先调用已有的初始化函数
        if (typeof initSettingsMenu === 'function') initSettingsMenu();
        if (typeof initBackgroundSettings === 'function') initBackgroundSettings();
        if (typeof renderTierCards === 'function') renderTierCards();
        // 如果 comments.js 中的功能也希望在这里统一初始化，确保它们在全局可用
        // 例如: if (typeof window.loadComments === 'function') window.loadComments();
        console.log('initializeApp function called');
      }

      // 样式切换功能
      document.addEventListener('DOMContentLoaded', function () {
        const styleButtons = document.querySelectorAll('.style-btn');
        const tierListContainer = document.querySelector('.tier-list-container');

        // 从本地存储加载样式设置
        const savedStyle = localStorage.getItem('anime-card-style') || '1';

        // 应用保存的样式
        applyCardStyle(savedStyle);

        // 设置对应按钮为激活状态
        styleButtons.forEach(btn => {
          if (btn.getAttribute('data-style') === savedStyle) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // 样式切换事件
        styleButtons.forEach(button => {
          button.addEventListener('click', function () {
            // 移除所有按钮的活跃状态
            styleButtons.forEach(btn => btn.classList.remove('active'));
            // 添加当前按钮的活跃状态
            this.classList.add('active');

            const styleOption = this.getAttribute('data-style');

            // 应用样式并保存设置
            applyCardStyle(styleOption);
            localStorage.setItem('anime-card-style', styleOption);
          });
        });

        // 应用卡片样式
        function applyCardStyle(styleOption) {
          // 首先移除所有样式类
          document.querySelectorAll('.card').forEach(card => {
            card.classList.remove('option-current', 'option-2', 'option-3', 'option-4');

            // 根据不同选项添加对应的样式类
            if (styleOption === '1') {
              // 默认样式 - 无文字
              tierListContainer.classList.add('hide-titles');
            } else if (styleOption === '2') {
              // 有文字样式
              tierListContainer.classList.remove('hide-titles');
              card.classList.add('option-current');
            }
          });
        }

        // 背景设置按钮事件
        const backgroundBtn = document.getElementById('background-settings-btn');
        const backgroundPanel = document.getElementById('background-settings-panel');

        if (backgroundBtn && backgroundPanel) {
          backgroundBtn.addEventListener('click', function () {
            backgroundPanel.classList.toggle('active');
          });
        }
      });

      // 设置面板折叠/展开功能
      function toggleSettingsSection(headerElement) {
        const section = headerElement.parentElement;
        section.classList.toggle('active');
      }

      // 点击其他地方关闭背景设置面板
      document.addEventListener('click', function (event) {
        const backgroundBtn = document.getElementById('background-settings-btn');
        const backgroundPanel = document.getElementById('background-settings-panel');

        if (
          backgroundBtn &&
          backgroundPanel &&
          !backgroundBtn.contains(event.target) &&
          !backgroundPanel.contains(event.target)
        ) {
          backgroundPanel.classList.remove('active');
        }
      });
    </script>

    <!-- Tag分析区域 -->
    <div class="tag-cloud-section">
      <div class="section-title-container">
        <h2 class="section-title">Tag分析</h2>
        <button id="load-tag-cloud-btn" class="load-tag-cloud-btn">
          <i class="fas fa-tags"></i>
          <span>加载Tag</span>
        </button>
        <span class="tag-cloud-note">注意：新添加动画后请重新点击加载Tag</span>
      </div>
      <div class="tag-cloud-wrapper">
        <div id="main-tag-cloud-container" class="main-tag-cloud-container">
          <!-- 标签云将在这里动态生成 -->
          <div class="tag-cloud-placeholder">
            <p>查看您添加的动画中最常见的标签</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 评论区标题 -->
    <div class="comments-section">
      <h2 class="comments-section-title">我的评论</h2>

      <!-- 评论卡片容器 -->
      <div class="comments-container">
        <!-- 评论将在这里动态生成 -->
      </div>
    </div>

    <!-- API密钥设置区域 -->
    <div class="api-key-standalone-section">
      <div class="api-key-header">
        <h3><i class="fas fa-key"></i> Gemini API 密钥设置</h3>
        <div class="api-key-status" id="api-key-status">
          <span class="status-indicator" id="status-indicator">
            <i class="fas fa-times-circle"></i>
          </span>
          <span class="status-text" id="status-text">未设置</span>
        </div>
      </div>

      <div class="api-key-content">
        <p class="api-key-description">设置 Gemini API 密钥以启用AI功能</p>
        <div class="api-key-security-notice">
          <i class="fas fa-shield-alt"></i>
          <span
            style="cursor: help"
            title="以上是AI的官方说辞，来自一个使用prompt当编程语言的开发者,我也看不懂代码XD,不过我拷打了AI,有让它发毒誓,大概率没问题^^"
          >
            您的API密钥仅保存在本地浏览器中，不会上传到任何服务器</span
          >
        </div>

        <div class="api-key-input-group">
          <input
            type="password"
            id="main-gemini-api-key"
            class="api-key-input"
            placeholder="请输入您的 Gemini API 密钥"
          />
          <button type="button" id="main-toggle-api-key-visibility" class="toggle-visibility-btn" title="显示/隐藏密钥">
            <i class="fas fa-eye"></i>
          </button>
        </div>

        <div class="model-selection-group">
          <label for="main-model-select" class="model-label"> <i class="fas fa-brain"></i> AI模型 </label>
          <select id="main-model-select" class="model-select">
            <option value="gemini-2.5-flash-preview-05-20">gemini-2.5-flash-preview-05-20</option>
            <option value="gemini-2.5-flash-preview-04-17">gemini-2.5-flash-preview-04-17</option>
            <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp</option>
            <option value="gemini-2.5-pro-preview-05-06">gemini-2.5-pro-preview-05-06 (付费KEY用)</option>
            <option value="custom">自定义模型</option>
          </select>
        </div>

        <div class="custom-model-group" id="custom-model-group" style="display: none">
          <label for="custom-model-input" class="model-label"> <i class="fas fa-edit"></i> 自定义模型 </label>
          <input type="text" id="custom-model-input" class="api-key-input" placeholder="如：gemini-pro-preview-05-06" />
        </div>

        <div class="api-key-actions">
          <button id="main-save-api-key-btn" class="api-key-btn primary">
            <i class="fas fa-save"></i>
            <span>保存</span>
          </button>
          <button id="main-test-api-key-btn" class="api-key-btn secondary" style="display: none">
            <i class="fas fa-vial"></i>
            <span>测试连接</span>
          </button>
          <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-key-btn secondary">
            <i class="fas fa-external-link-alt"></i>
            <span>获取密钥</span>
          </a>
        </div>

        <div class="api-key-help">
          <details>
            <summary><i class="fas fa-question-circle"></i> 如何获取？</summary>
            <ol>
              <li>点击"获取密钥"链接</li>
              <li>使用Google账号登录</li>
              <li>创建API Key</li>
              <li>复制并粘贴到输入框</li>
              <li>点击"保存"完成设置</li>
            </ol>
          </details>
        </div>
      </div>
    </div>

    <!-- AI总结报告区域 - 全新Glassmorphism设计 -->
    <div class="taste-report-standalone-section" id="main-taste-report-section" style="display: none">
      <div class="taste-report-header">
        <!-- 标题行 -->
        <div class="taste-report-title-row">
          <h3><i class="fas fa-brain"></i> AI总结报告</h3>
          <div class="role-selector-container">
            <label for="role-select" class="role-select-label"><i class="fas fa-user-astronaut"></i> 选择AI角色:</label>
            <select id="role-select" class="role-select">
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>
        </div>

        <!-- 控制按钮行 -->
        <div class="taste-report-controls">
          <button id="main-generate-taste-report-btn" class="taste-report-btn primary">
            <i class="fas fa-magic"></i>
            <span>生成总结报告</span>
          </button>
          <!-- 隐藏查看完整Prompt功能 -->
          <!--
          <button id="main-view-prompt-btn" class="taste-report-btn secondary" style="display: none">
            <i class="fas fa-code"></i>
            <span>查看完整Prompt</span>
          </button>
          -->
          <button
            id="clear-cache-btn"
            class="taste-report-btn secondary"
            title="清理动画数据缓存，下次生成时重新获取最新数据"
          >
            <i class="fas fa-trash-alt"></i>
            <span>清理缓存</span>
          </button>
        </div>
      </div>

      <div class="taste-report-content" id="main-taste-report-content">
        <!-- AI角色Banner -->
        <div class="ai-role-banner" id="ai-role-banner">
          <div class="banner-background">
            <img
              src="https://files.catbox.moe/48ttww.png"
              alt="AI角色"
              class="banner-character-image"
              id="banner-character-image"
            />
            <div class="banner-overlay"></div>
          </div>
          <div class="banner-content">
            <div class="banner-text">
              <h3 class="banner-title" id="banner-title">MESUGAKI</h3>
            </div>
          </div>
        </div>

        <div class="taste-report-placeholder">
          <i class="fas fa-lightbulb"></i>
          <h4>AI偏好分析</h4>
          <p>添加一些动画到您的分级列表，然后点击"生成总结报告"，让AI分析您的动画偏好！</p>
          <ul>
            <li>🎯 个性化分析您的动画偏好</li>
            <li>📊 基于制作公司、声优、标签的深度解析</li>
            <li>🌊 支持流式传输，实时显示生成过程</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- 导出图片对话框 -->
    <div id="export-image-dialog" class="export-dialog">
      <div class="export-dialog-content">
        <button class="export-dialog-close"><i class="fas fa-times"></i></button>
        <h3 class="export-dialog-title">导出为图片</h3>
        <div class="export-dialog-body">
          <div id="export-loading" class="export-loading">
            <div class="spinner"></div>
            <p>正在生成图片，请稍候...</p>
          </div>
          <img id="export-preview" class="export-preview" src="" alt="预览" style="display: none" />
        </div>
        <div class="export-dialog-actions">
          <button id="download-image-btn" class="export-dialog-btn primary">
            <i class="fas fa-download"></i>
            <span>下载图片</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 分享链接对话框 -->
    <div id="share-link-dialog" class="export-dialog">
      <div class="export-dialog-content">
        <button class="export-dialog-close"><i class="fas fa-times"></i></button>
        <h3 class="export-dialog-title">分享链接</h3>
        <div class="export-dialog-body">
          <p>复制以下链接分享你的Tier List：</p>
          <input type="text" id="share-link-input" class="share-link-input" readonly />
        </div>
        <div class="export-dialog-actions">
          <button id="copy-link-btn" class="export-dialog-btn primary">
            <i class="fas fa-copy"></i>
            <span>复制链接</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 导入确认对话框 -->
    <div id="import-confirm-dialog" class="export-dialog">
      <div class="export-dialog-content">
        <button class="export-dialog-close"><i class="fas fa-times"></i></button>
        <h3 class="export-dialog-title">导入数据</h3>
        <div class="export-dialog-body">
          <p>导入将覆盖当前的所有数据，确定要继续吗？</p>
        </div>
        <div class="export-dialog-actions">
          <button id="cancel-import-btn" class="export-dialog-btn">
            <i class="fas fa-times"></i>
            <span>取消</span>
          </button>
          <button id="confirm-import-btn" class="export-dialog-btn primary">
            <i class="fas fa-check"></i>
            <span>确认导入</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 总结报告对话框 -->
    <div
      id="taste-report-dialog"
      class="export-dialog"
      role="dialog"
      aria-modal="true"
      aria-labelledby="taste-report-title"
    >
      <div class="export-dialog-content">
        <button class="export-dialog-close" aria-label="关闭总结报告对话框"><i class="fas fa-times"></i></button>
        <h3 id="taste-report-title" class="export-dialog-title">您的动画总结报告</h3>
        <div id="taste-report-body" class="export-dialog-body">
          <!-- 初始状态 -->
          <div class="taste-report-setup">
            <div class="api-key-section">
              <h4><i class="fas fa-key"></i> API 密钥设置</h4>
              <p class="api-key-description">需要 Google Gemini API 密钥来生成总结报告。</p>
              <div class="api-key-security-notice">
                <i class="fas fa-shield-alt"></i>
                <span>您的API密钥仅保存在本地浏览器中，不会上传到任何服务器</span>
              </div>
              <div class="api-key-input-group">
                <input
                  type="password"
                  id="gemini-api-key"
                  class="api-key-input"
                  placeholder="请输入您的 Gemini API 密钥"
                />
                <button
                  type="button"
                  id="toggle-api-key-visibility"
                  class="toggle-visibility-btn"
                  title="显示/隐藏密钥"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="api-key-actions">
                <button id="save-api-key-btn" class="api-key-btn primary">
                  <i class="fas fa-save"></i>
                  <span>保存密钥</span>
                </button>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-key-btn secondary">
                  <i class="fas fa-external-link-alt"></i>
                  <span>获取免费API密钥</span>
                </a>
              </div>
              <div class="api-key-help">
                <details>
                  <summary><i class="fas fa-question-circle"></i> 如何获取API密钥？</summary>
                  <ol>
                    <li>点击上方"获取免费API密钥"链接</li>
                    <li>使用Google账号登录</li>
                    <li>点击"Create API Key"创建密钥</li>
                    <li>复制生成的密钥并粘贴到上方输入框</li>
                    <li>点击"保存密钥"完成设置</li>
                  </ol>
                </details>
              </div>
            </div>
            <div class="generate-report-section" style="display: none">
              <h4><i class="fas fa-brain"></i> 生成总结报告</h4>
              <p>AI 将分析您的 Tier List 中的动画，生成个性化的总结报告。</p>
              <button id="start-analysis-btn" class="start-analysis-btn">
                <i class="fas fa-magic"></i>
                <span>开始分析我的偏好</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 隐藏查看完整Prompt对话框功能 -->
    <!--
    <div id="view-prompt-dialog" class="export-dialog">
      <div class="export-dialog-content">
        <button class="export-dialog-close"><i class="fas fa-times"></i></button>
        <h3 class="export-dialog-title">完整LLM Prompt</h3>
        <div class="export-dialog-body">
          <div class="prompt-content">
            <pre id="prompt-text" class="prompt-text"></pre>
          </div>
        </div>
        <div class="export-dialog-actions">
          <button id="copy-prompt-btn" class="export-dialog-btn primary">
            <i class="fas fa-copy"></i>
            <span>复制Prompt</span>
          </button>
        </div>
      </div>
    </div>
    -->

    <!-- 动画详情对话框 -->
    <div id="anime-detail-dialog" class="export-dialog">
      <div class="export-dialog-content anime-detail-content">
        <button class="export-dialog-close"><i class="fas fa-times"></i></button>
        <div class="anime-detail-header">
          <div class="anime-detail-cover">
            <img id="detail-cover" src="" alt="封面" />
          </div>
          <div class="anime-detail-info">
            <h3 id="detail-title" class="anime-detail-title"></h3>
            <h4 id="detail-title-cn" class="anime-detail-title-cn"></h4>
            <div class="anime-detail-meta">
              <div class="meta-item">
                <span class="meta-label"><i class="fas fa-calendar-alt"></i> 放送日期:</span>
                <span id="detail-air-date" class="meta-value"></span>
              </div>
              <div class="meta-item">
                <span class="meta-label"><i class="fas fa-star"></i> 评分:</span>
                <span id="detail-rating" class="meta-value"></span>
              </div>
              <div class="meta-item">
                <span class="meta-label"><i class="fas fa-list-ol"></i> 排名:</span>
                <span id="detail-rank" class="meta-value"></span>
              </div>
              <div class="meta-item">
                <span class="meta-label"><i class="fas fa-film"></i> 集数:</span>
                <span id="detail-eps" class="meta-value"></span>
              </div>
            </div>
            <div class="anime-detail-tags" id="detail-tags"></div>
          </div>
        </div>
        <div class="anime-detail-body">
          <div class="detail-section">
            <h4 class="detail-section-title"><i class="fas fa-info-circle"></i> 简介</h4>
            <div id="detail-summary" class="detail-section-content"></div>
          </div>
          <div class="detail-section">
            <h4 class="detail-section-title"><i class="fas fa-building"></i> 制作信息</h4>
            <div id="detail-infobox" class="detail-section-content"></div>
          </div>
        </div>
        <div class="anime-detail-actions">
          <a id="detail-bgm-link" href="#" target="_blank" class="export-dialog-btn secondary">
            <i class="fas fa-external-link-alt"></i>
            <span>在Bangumi上查看</span>
          </a>
        </div>
      </div>
    </div>

    <!-- 右键菜单 -->
    <div id="context-menu" class="context-menu">
      <div class="context-menu-item" id="edit-option">
        <i class="fas fa-edit"></i>
        <span>编辑</span>
      </div>
      <div class="context-menu-item" id="detail-option">
        <i class="fas fa-info-circle"></i>
        <span>查看详情</span>
      </div>
      <div class="context-menu-item" id="delete-option">
        <i class="fas fa-trash"></i>
        <span>删除</span>
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" id="add-comment-option">
        <i class="fas fa-comment-medical"></i>
        <span>添加评论</span>
      </div>
    </div>

    <!-- 评论对话框 -->
    <div id="comment-dialog" class="export-dialog">
      <div class="export-dialog-content">
        <button class="export-dialog-close"><i class="fas fa-times"></i></button>
        <h3 class="export-dialog-title">添加评论</h3>
        <div class="export-dialog-body">
          <div class="comment-dialog-header">
            <div class="comment-dialog-cover">
              <img id="comment-anime-cover" src="" alt="动画封面" />
              <h4 id="comment-anime-title" class="comment-dialog-title"></h4>
            </div>
          </div>
          <div class="comment-input-container">
            <label for="comment-text">你的评论:</label>
            <textarea id="comment-text" class="comment-textarea" placeholder="写下你对这部动画的想法..."></textarea>
          </div>
          <div class="comment-style-selector">
            <label>评论样式:</label>
            <div class="comment-style-container">
              <div class="comment-style-option" data-style="1">
                <i class="fas fa-columns"></i>
                <span>右侧图片</span>
              </div>
              <div class="comment-style-option" data-style="2">
                <i class="fas fa-image"></i>
                <span>大图顶部</span>
              </div>
              <div class="comment-style-option" data-style="3">
                <i class="fas fa-layer-group"></i>
                <span>背景覆盖</span>
              </div>
              <div class="comment-style-option" data-style="4">
                <i class="fas fa-id-card"></i>
                <span>卡片式</span>
              </div>
              <div class="comment-style-option random-style active" data-style="random">
                <i class="fas fa-random"></i>
                <span>随机样式</span>
              </div>
            </div>
          </div>
        </div>
        <div class="export-dialog-actions">
          <button id="cancel-comment-btn" class="export-dialog-btn">
            <i class="fas fa-times"></i>
            <span>取消</span>
          </button>
          <button id="save-comment-btn" class="export-dialog-btn primary">
            <i class="fas fa-save"></i>
            <span>保存评论</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 页面声明 -->
    <footer class="page-footer">
      <div class="footer-content">
        <a href="https://github.com/ikemenrourou" target="_blank">@ikemenrourou</a>
        <a href="https://github.com/ikemenrourou/BGM-AniTier" target="_blank">GitHub</a>
        <span>动画信息来自 <a href="https://bgm.tv/" target="_blank">番组计划</a></span>
        <span>搜索功能参考 <a href="https://github.com/itorr/anime-grid" target="_blank">anime-grid</a></span>
        <span class="usage-notice">仅供个人学习使用，禁止商业用途</span>
      </div>
    </footer>
  </body>
</html>
